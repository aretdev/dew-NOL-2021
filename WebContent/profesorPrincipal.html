<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="UTF-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" type="text/javascript"></script>


	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>


	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" type="text/css" rel="stylesheet"/>
	<script>
	var visualizandoAlumno = "";
	var visualizandoAsignatura = "";
	var dniProfesor = "";
	
	var jsonGlobal = new Array();
	
	function siguienteAlumno(){
		
	}
	function anteriorAlumno(){
	}
	
	function getNombre(dni){
		var res = "";
		$.ajax({
			url: '/dew-NOL-2021/profesorApi',
			type: 'POST',
			dataType: 'json',
			async: false,
			data: 'opcion=getalumno&dnialumno='+dni,
			success: function(data){
				res = data.nombre + " " + data.apellidos;
			},
			error: function(){
				$("#insertar-asignaturas-prof").append("<p>ERROR EN AJAX</p>");
			}
			});
		return res;
	}
	function showPopUp(dni, nombre, acron){
		$("#ModalTitulo").html("Cambiar nota - " + nombre + " [" + dni + "]")
		var nota = document.getElementById(dni).getAttribute("nota");
		$("#insertar-nota").html(nota)
		visualizandoAlumno = dni;
		visualizandoAsignatura = acron;
		$('#cambiarNota').modal('toggle')
		
	}
	
	function actualizarNota(){
		var nota = $("#nuevaNota").val();
		$.ajax({
			url: '/dew-NOL-2021/profesorApi',
			type: 'POST',
			async: false,
			data: 'opcion=setnota&dnialumno='+visualizandoAlumno+"&nota="+nota+"&acron="+visualizandoAsignatura,
			success: function(data){
				console.log(nota)
				document.getElementById(visualizandoAlumno).setAttribute("nota", nota)
				$("#insertar-nota").html(nota);
				
			},
			error: function(){
				console.log("ERROR EN AJAX");
			}
			});
		
	}
	$(document).ready(function(){
		$.ajax({
			url: '/dew-NOL-2021/profesorApi',
			type: 'POST',
			dataType: 'json',
			async: false,
			data: 'opcion=profasig',
			success: function(data){
				$.each(data, function (index, val) {
					var divMain = document.createElement('div')
					divMain.className = "accordion-item"
					var h2Header = document.createElement('h2')
					h2Header.className = "accordion-header"
					var button = document.createElement('button')
					button.className="accordion-button collapsed"; 
					button.type="button"; 
					button.setAttribute("data-bs-toggle","collapse")
					button.setAttribute("data-bs-target","#asig-"+val.acronimo)
					button.setAttribute("aria-expanded","false")
					button.setAttribute("aria-controls","flush-collapse"+val.acronimo)
					button.innerHTML = val.acronimo;
					h2Header.appendChild(button)
					divMain.appendChild(h2Header)
					
					var divSecond = document.createElement('div')
					divSecond.id="asig-"+val.acronimo; 
					divSecond.className="accordion-collapse collapse";  
					divSecond.setAttribute("data-bs-parent","#contenedorAsig");
					divMain.appendChild(divSecond)
					$.ajax({
						url: '/dew-NOL-2021/profesorApi',
						type: 'POST',
						dataType: 'json',
						async: false,
						data: 'opcion=asigalum&acronimo='+val.acronimo,
						success: function(data1){
							var divAlum = document.createElement('div')
							divAlum.className="accordion-body"
							
							var ulAlum = document.createElement('ul')
							ulAlum.className="list-group"
							ulAlum.id = "asigUL"+index
							
							
							var asignatura =  val.acronimo;
							var a = new Object();
							
                            a.alumnos = []
							
                            $.each(data1, function (index1, val1) {
								var a = getNombre(val1.alumno);
	                            var li = document.createElement('li')
	                            li.className="list-group-item"
	                            li.innerHTML = a + " con dni: "+ val1.alumno
	                            var button = document.createElement('button')
	                            button.id = val1.alumno
	                            button.className = "btn-sm btn-outline-success pull-right"
	                            button.innerHTML = "Añadir nota"
	                            var nota = (val1.nota == "") ? 0 : val1.nota
	                            button.setAttribute("nota",nota)
	                            button.setAttribute("onclick","showPopUp('"+val1.alumno+"','"+ a + "','"+ val.acronimo + "')")
	                            button.setAttribute("data-target","#cambiarNota")
	                            button.setAttribute("data-toggle","modal")
	                            li.appendChild(button)
	                            ulAlum.appendChild(li)  
	                            
	                            var alumno = new Object();
	                            alumno.dni = val1.alumno;
	                            alumno.nombre = a;
	                            alumno.nota = nota;
	                            
	                            
	                            $.getJSON("/dew-NOL-2021/profesorApi?opcion=avatar&dniavatar="+val1.alumno)
	                			.done(function(response){
	                			
	                			alumno.img = response.img;
	                			
	                			}).fail(function() {
	                			 alert("Algo mal: ");
	                			});
	                            
	                            alumnos.push(alumno);
	                            
							  });
							divAlum.appendChild(ulAlum)
							divSecond.appendChild(divAlum);
							var contenedor = document.getElementById('contenedorAsig')
							contenedor.appendChild(divMain)
							jsonGlobal.push(asignatura);
							var jsonString = JSON.stringify(jsonGlobal);
							console.log(jsonString);
						},
						error: function(){
							$("#insertar-asignaturas-prof").append("<p>ERROR EN AJAX</p>");
						}
						});
					
					
				  });
				
			},
			error: function(){
				$("#insertar-asignaturas-prof").append("<p>ERROR EN AJAX</p>");
			}
			});
		
			$.ajax({
	            url: '/dew-NOL-2021/profesorApi',
	            type: 'POST',
	            dataType: 'json',
	            async: false,
	            data: 'opcion=dni',
	            success: function(data){
	                $("#insertar-dni").append(data.nombre + " " + data.apellidos)
	                dniProfesor = data.dni;
	            },
	            error: function(){
	                $("#insertar-dni").append("<p>ERROR EN AJAX</p>");
	            }
	        })
	        
	        $.getJSON("/dew-NOL-2021/profesorApi?opcion=avatar&dniavatar="+dniProfesor)
			.done(function(response){
			$("#esto").text(response.dni);
			$("#aqui").attr("src", "data:image/png;base64,"+response.img);
			})
			.fail(function() {
			 alert("Algo mal: ");
			});
		})
	
	
	</script>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">NOL</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="#">Inicio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Asignaturas</a>
        </li>
      </ul>
  <div class="text-end">
          <button type="button" class="btn btn-outline-light me-2">Perfil</button>
          <button type="button" class="btn btn-danger"><a href="/dew-NOL-2021/logout">Salir</a></button>
        </div>
    </div>
  </div>
</nav>
<div class="container">
	 <div class="d-flex justify-content-center">
		<div class="card bg-light mb-3 mt-4 " style="width: 30.7rem;">
		  <div class="card-header text-center">Información - Profesor</div>
		  <div class="card-body d-flex justify-content-center">
		  	<div class="container-sm ">
			  <div class="row">
			    <div class="col">
			      <img class="rounded-circle mx-auto d-block shadow-sm" id="aqui" height="125">
			    </div>
			    <div class="col" >
			      <p>Bienvenido <span><b id="insertar-dni"></b></span> a Notas Online</p>
			      <p>Tu dni es: <b id="esto"></b></p>
			    </div>
			  </div>
			</div>
		  </div>
		</div>
	</div>
	<div class="accordion accordion-flush border" id="contenedorAsig">
	</div>
    
</div>
	
<div class="modal fade" id="cambiarNota" tabindex="-1" role="dialog" aria-labelledby="ModalTitulo" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="text-align: center;" id="ModalTitulo"></h5>
      </div>
      <div class="modal-body">
       		<div class="container-sm ">
			  <div class="row">
			    <div class="col">
			      <img class="rounded-circle mx-auto d-block shadow-sm" id="aqui2" height="125">
			    </div>
			    <div class="col" >
			      <p>La nota del alumno es: <span><b id="insertar-nota"></b></span></p>
			      <p>
			      <input id="nuevaNota" class="form-control" type="number" placeholder="Nota [0-10]">
			      
			      </p>
			    </div>
			  </div>
			  <div class="d-flex justify-content-center mt-5">
			  <div class="btn-group" role="group" aria-label="Basic example">
				  <button type="button" onclick="anteriorAlumno()" class="btn btn-primary">Anterior</button>
				  <button type="button" onclick="actualizarNota()" class="btn btn-success">Calificar</button>
				  <button type="button" onclick="siguienteAlumno()"class="btn btn-primary">Siguiente</button>
				</div>
			  </div>
			</div>
      </div>
    </div>
  </div>
</div>



</body>
</html>